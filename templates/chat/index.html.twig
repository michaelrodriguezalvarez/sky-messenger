{% extends 'base.html.twig' %}

{% block title %}Chat{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('vendor/chat/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ asset('vendor/chat/css/all.css') }}">
    <link rel="stylesheet" href="{{ asset('vendor/chat/css/main.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('vendor/chat/css/jquery.mCustomScrollbar.min.css') }}">

{% endblock %}


{% block javascripts %}
        {# Scripts de la plantilla #}
        <script src="{{ asset('vendor/chat/js/jquery.min.js') }}"></script>
        <script type="text/javascript" src="{{ asset('vendor/chat/js/jquery.mCustomScrollbar.min.js') }}"></script>
        <script type="text/javascript" src="{{ asset('vendor/chat/js/main.js') }}"></script>

    <script type="text/javascript">    
        var usuarios_logueados = [];
        var base_url = ''+'{{ app.request.baseUrl }}'+'';
        var id_destinatario_seleccionado = -1;
        var nick_destinatario_seleccionado = '';
        var iniciando = true;

        ActualizarUsuariosLogueados = function (){
                $.get("{{path('get_logued_users')}}", function(data, status){
                    $("#listado_destinatarios ul").empty();
                    if(status == 'success' && data.success == true){
                        usuarios_logueados = data.data;  
                        usuarios_logueados.map(function (element){
                            
                            //Array para mostrar el rol de forma mas legible a los usuarios
                            $roles = [];
                            $roles["ROLE_USER"]="(Usuario)";$roles["ROLE_ADMIN"]="(Administrador)";

                            if(element.id != -1){ //Si no es la sala publica 
                                if(element.id != '{{ perfil.usuario.id }}'){ //Si no es el usuario logueado
                                    $("#listado_destinatarios ul").append('<li><a href="#" onclick="EstablecerDestinatario('+element.id+',\''+element.nick+'\');">'+element.nick+'</a><span> '+ $roles[element.roles]+' </span><a target="_blank" href="'+base_url+'/perfil/'+element.perfil+'">(Ver perfil)</a></li>');
                                }
                            }else{ //La sala publica no require de perfil
                                $("#listado_destinatarios ul").append('<li><a href="#" onclick="EstablecerDestinatario('+element.id+',\''+element.nick+'\');">'+element.nick+'</a></li>');
                            }                            
                        });

                        if(iniciando == true && usuarios_logueados.length > 0){
                            EstablecerDestinatario(usuarios_logueados[0].id, usuarios_logueados[0].nick);
                            iniciando = false;
                        }
                    }else{
                        usuarios_logueados = [];
                        $("#listado_destinatarios ul").append('<li>Error cargando los elementos :-(</li>');
                        $('#destinatario').text('Error cargando el elemento :-(');
                    }             
                });  
            };

        EstablecerDestinatario = function (id_destinarario, nick_destinatario){           
            id_destinatario_seleccionado = id_destinarario;
            nick_destinatario_seleccionado = nick_destinatario;
            $('#destinatario').text(nick_destinatario_seleccionado);
        }

        EnviarMensaje = function(){
            var texto = $("#texto").val();            
            var _token = $("#_token").val();

            if(texto != ""){
                $.post(
                        "{{path('mensaje_enviar')}}", 
                        {
                            texto: texto, 
                            destinatario: id_destinatario_seleccionado, 
                            _token: _token
                        }, 
                        function(data, status){
                            if(status == 'success' && data.success == true){
                                $("#texto").val("");
                                $("#texto").focus();
                                console.log(data.data);
                            }else{
                                alert("Error: "+ data.error);
                            }
                        }
                    );
            }else{
                alert("Error: You have must text any message.");
            }            
        }

        //Cuando el documento cargue
        $(document).ready(function (){            
            ActualizarUsuariosLogueados();

            $('#texto').keypress(function(event){
                var keycode = (event.keyCode ? event.keyCode : event.which);
                if(keycode == '13'){
                    EnviarMensaje();  
                }
            });

        });
        
    </script>
{% endblock %}

{% block body %}
<header>
<div>Conversación con <b><span id="destinatario">Cargando...</span></b></div>
<div>
<span>Usted ha accedido como <b>{{ perfil.nick }}</b></span>
<a href="{{ path ('app_logout')}}">(Salir)</a>
<br />
<a target="_blank" href="{{ path ('perfil_show', {'id':perfil.id})}}">(Mi perfil)</a>
<br />
{% if is_granted('ROLE_ADMIN') %}
    <a target="_blank" href="{{ path ('app_admin') }}">(Administrar)</a>
{% endif %}
</div>
</header>

<article>
    <section>
        Areas para los mensajes remitente y destinatario (1)
    </section>
    <section>
        Areas para los mensajes remitente y destinatario (2)
    </section>
</article>

<aside>
    <button type="button" onclick="ActualizarUsuariosLogueados()">Actualizar</button>
    <div id="listado_destinatarios">
        <ul>
            <li>Cargando...</li>
        </ul>
    </div>    
</aside>

<article>
<input type="hidden" id="_token" name="_token" value="{{ csrf_token('enviar_mensaje' ~ perfil.usuario.id) }}">
{# <input id="texto" type="text" name="texto" placeholder="Escriba el mensaje">
<button type="submit" onclick="EnviarMensaje()">Enviar</button> #}
</article>
{# PLANTILLA ====================================================================================================================================================================================#}

<div class="container-fluid h-100">
			<div class="row justify-content-center h-100">
				<div class="col-md-4 col-xl-3 chat"><div class="card mb-sm-3 mb-md-0 contacts_card">

                    {# Buscar #}
					<div class="card-header">
						<div class="input-group">
							<input type="text" placeholder="Search..." name="" class="form-control search">
							<div class="input-group-prepend">
								<span class="input-group-text search_btn"><i class="fas fa-search"></i></span>
							</div>
						</div>
					</div>

                    {# Lista de Usuarios Conectados #}
					<div class="card-body contacts_body">
						<ui class="contacts">
						<li class="active">
							<div class="d-flex bd-highlight">
								<div class="img_cont">
									<img src="{{ asset('vendor/chat/img/_D.jpg') }}" class="rounded-circle user_img">
									<span class="online_icon"></span>
								</div>
								<div class="user_info">
									<span>Khalid</span>
									<p>Kalid is online</p>
								</div>
							</div>
						</li>
						<li>
							<div class="d-flex bd-highlight">
								<div class="img_cont">
									<img src="{{ asset('vendor/chat/img/31.jpg') }}" class="rounded-circle user_img">
									<span class="online_icon offline"></span>
								</div>
								<div class="user_info">
									<span>Taherah Big</span>
									<p>Taherah left 7 mins ago</p>
								</div>
							</div>
						</li>
						<li>
							<div class="d-flex bd-highlight">
								<div class="img_cont">
									<img src="{{ asset('vendor/chat/img/acb990190ca1ddbb9b20db303375bb58.jpg') }}" class="rounded-circle user_img">
									<span class="online_icon"></span>
								</div>
								<div class="user_info">
									<span>Sami Rafi</span>
									<p>Sami is online</p>
								</div>
							</div>
						</li>
						<li>
							<div class="d-flex bd-highlight">
								<div class="img_cont">
									<img src="{{ asset('vendor/chat/img/acb990190ca1ddbb9b20db303375bb58.jpg') }}" class="rounded-circle user_img">
									<span class="online_icon offline"></span>
								</div>
								<div class="user_info">
									<span>Nargis Hawa</span>
									<p>Nargis left 30 mins ago</p>
								</div>
							</div>
						</li>
						<li>
							<div class="d-flex bd-highlight">
								<div class="img_cont">
									<img src="{{ asset('vendor/chat/img/boy-cartoon-3D-model_D.jpg') }}" class="rounded-circle user_img">
									<span class="online_icon offline"></span>
								</div>
								<div class="user_info">
									<span>Rashid Samim</span>
									<p>Rashid left 50 mins ago</p>
								</div>
							</div>
						</li>
						</ui>
					</div>
					<div class="card-footer"></div>
				</div></div>

                {# Panel Principal donde se muestran los mensajes etc.... #}
				<div class="col-md-8 col-xl-6 chat">
					<div class="card">
						<div class="card-header msg_head">
							<div class="d-flex bd-highlight">
								<div class="img_cont">
									<img src="{{ asset('vendor/chat/img/_D.jpg') }}" class="rounded-circle user_img">
									<span class="online_icon"></span>
								</div>
								<div class="user_info">
									<span>Chat with Khalid</span>
									<p>1767 Messages</p>
								</div>
								<div class="video_cam">
									<span><i class="fas fa-video"></i></span>
									<span><i class="fas fa-phone"></i></span>
								</div>
							</div>
							<span id="action_menu_btn"><i class="fas fa-ellipsis-v"></i></span>
							<div class="action_menu">
								<ul>
									<li><i class="fas fa-user-circle"></i> <a target="_blank" href="{{ path ('perfil_show', {'id':perfil.id})}}">Mi Perfil</a></li>

                                    {% if is_granted('ROLE_ADMIN') %}
									<li><i class="fas fa-lock"></i> <a target="_blank" href="{{ path ('app_admin') }}">Administración</a></li>
                                    {% endif %}

									<li><i class="fas fa-minus-circle"></i><a href="{{ path ('app_logout')}}">Salir</a></li>
									{# <li><i class="fas fa-ban"></i> Block</li> #}
								</ul>
							</div>
						</div>
						<div class="card-body msg_card_body">
							<div class="d-flex justify-content-start mb-4">
								<div class="img_cont_msg">
									<img src="{{ asset('vendor/chat/img/_D.jpg') }}" class="rounded-circle user_img_msg">
								</div>
								<div class="msg_cotainer">
									Hi, how are you samim?
									<span class="msg_time">8:40 AM, Today</span>
								</div>
							</div>
							<div class="d-flex justify-content-end mb-4">
								<div class="msg_cotainer_send">
									Hi Khalid i am good tnx how about you?
									<span class="msg_time_send">8:55 AM, Today</span>
								</div>
								<div class="img_cont_msg">
							
								</div>
							</div>
							<div class="d-flex justify-content-start mb-4">
								<div class="img_cont_msg">
									<img src="{{ asset('vendor/chat/img/_D.jpg') }}" class="rounded-circle user_img_msg">
								</div>
								<div class="msg_cotainer">
									I am good too, thank you for your chat template
									<span class="msg_time">9:00 AM, Today</span>
								</div>
							</div>
							<div class="d-flex justify-content-end mb-4">
								<div class="msg_cotainer_send">
									You are welcome
									<span class="msg_time_send">9:05 AM, Today</span>
								</div>
								<div class="img_cont_msg">
							
								</div>
							</div>
							<div class="d-flex justify-content-start mb-4">
								<div class="img_cont_msg">
									<img src="{{ asset('vendor/chat/img/_D.jpg') }}" class="rounded-circle user_img_msg">
								</div>
								<div class="msg_cotainer">
									I am looking for your next templates
									<span class="msg_time">9:07 AM, Today</span>
								</div>
							</div>
							<div class="d-flex justify-content-end mb-4">
								<div class="msg_cotainer_send">
									Ok, thank you have a good day
									<span class="msg_time_send">9:10 AM, Today</span>
								</div>
								<div class="img_cont_msg">
						
								</div>
							</div>
							<div class="d-flex justify-content-start mb-4">
								<div class="img_cont_msg">
									<img src="{{ asset('vendor/chat/img/_D.jpg') }}" class="rounded-circle user_img_msg">
								</div>
								<div class="msg_cotainer">
									Bye, see you
									<span class="msg_time">9:12 AM, Today</span>
								</div>
							</div>
						</div>
						<div class="card-footer">
							<div class="input-group">
								<div class="input-group-append">
									<span class="input-group-text attach_btn"><i class="fas fa-paperclip"></i></span>
								</div>

                                {# TextEdit para enviar mensajes #}
                                <input id="texto" type="text" name="texto" class="form-control type_msg" placeholder="Escriba el mensaje">

								
								<div class="input-group-append">
                                <button type="submit" onclick="EnviarMensaje()" class="input-group-text send_btn"><i class="fas fa-location-arrow"></i> </button>
									
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

{% endblock %}
